name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build
      run: npm run build
    
    - name: Lint
      run: |
        if [ -f .eslintrc.json ]; then
          npx eslint src/ --ext .ts || true
        fi
    
    - name: Type check
      run: npx tsc --noEmit
    
    - name: Check for secrets
      run: |
        # Check for common secret patterns
        if git log --all --full-history --source -- "*" | grep -iE "(api[_-]?key|secret|password|token|auth)" | grep -vE "(your-|example|placeholder|test)" | grep -v "GEMINI_API_KEY.*your-api-key"; then
          echo "⚠️  Potential secrets found in git history"
          exit 1
        fi
        echo "✅ No secrets found"

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run npm audit
      run: npm audit --audit-level=moderate || true
    
    - name: Check for hardcoded secrets
      run: |
        # Check current files (not git history)
        if grep -r "AIzaSy\|sk-\|pk_\|xoxb-\|ghp_\|gho_\|ghu_\|ghs_\|ghr_" --include="*.ts" --include="*.js" --include="*.json" --include="*.md" src/ 2>/dev/null | grep -v "your-api-key\|example\|placeholder"; then
          echo "❌ Potential API keys found in source files"
          exit 1
        fi
        echo "✅ No hardcoded secrets in source files"

