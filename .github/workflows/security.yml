name: Security Scan

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    - cron: '0 0 * * 0' # Weekly

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for secret scanning
    
    - name: Check for secrets in git history
      run: |
        # Check for common API key patterns
        PATTERNS=(
          "AIzaSy[A-Za-z0-9_-]{35}"
          "sk-[A-Za-z0-9]{32,}"
          "xoxb-[0-9]{11,13}-[0-9]{11,13}-[A-Za-z0-9]{24,32}"
          "ghp_[A-Za-z0-9]{36}"
        )
        
        FOUND=0
        for pattern in "${PATTERNS[@]}"; do
          if git log --all --full-history -S "$pattern" --source -- "*" 2>/dev/null | grep -q .; then
            echo "‚ö†Ô∏è  Potential secret pattern found: $pattern"
            FOUND=1
          fi
        done
        
        if [ $FOUND -eq 1 ]; then
          echo "‚ö†Ô∏è  WARNING: Secrets detected in git history!"
          echo "üìù To remove secrets from history, use:"
          echo "   pip install git-filter-repo"
          echo "   git filter-repo --path-glob '*.json' --path-glob '*.md' --invert-paths --replace-text <(echo 'AIzaSyAM6FE4xyyX0cGwam-AlVDSv3cr514OK9A==>your-api-key-here')"
          echo ""
          echo "‚ö†Ô∏è  If this was a real API key, rotate it immediately!"
          echo "‚ö†Ô∏è  This check will fail until secrets are removed from history."
          exit 1
        fi
        
        echo "‚úÖ No secrets found in git history"

